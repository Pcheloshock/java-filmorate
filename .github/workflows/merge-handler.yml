name: Post-Merge Processing
on:
  pull_request:
    types: [closed]

jobs:
  handle-approved-merge:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–µ—Ä–∂–µ –≤ main
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'

    runs-on: ubuntu-latest

    # –ü—Ä–∞–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å git

      # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ç–∫—É –ø–æ –≤–∞—à–µ–º—É —Å–ø–∏—Å–∫—É
      - name: Validate branch
        id: check-branch
        run: |
          CURRENT_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "Processing branch: $CURRENT_BRANCH"
          
          # –í–∞—à —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –≤–µ—Ç–æ–∫
          case "$CURRENT_BRANCH" in
            add-common-films|add-director|add-feed|add-marks|add-most-populars|add-recommendations|add-remove-endpoint|add-reviews|add-search|add-friends-likes)
              echo "‚úÖ Branch $CURRENT_BRANCH is approved"
              echo "approved=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "‚ùå Branch $CURRENT_BRANCH is NOT in approved list"
              echo "approved=false" >> $GITHUB_OUTPUT
              ;;
          esac

      # 3. –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è approved –≤–µ—Ç–æ–∫
      - name: Execute merge actions
        if: steps.check-branch.outputs.approved == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Starting post-merge actions for PR #${{ github.event.pull_request.number }}"
          
          # === –ö–û–ù–ö–†–ï–¢–ù–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –í–ê–° ===
          
          # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ—Ä–∂–∏—Ç–¨ –¥—Ä—É–≥–∏–µ PR –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–µ—Ä–∂–∞:
          if [[ "${{ github.event.pull_request.head.ref }}" == "add-friends-likes" ]]; then
            echo "üìå Processing add-friends-likes branch..."
          
            # –ü—Ä–∏–º–µ—Ä: –∑–∞–ø—É—Å–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
            echo "üß™ Running integration tests..."
            # mvn test -Dtest="*Friends*Test,*Likes*Test"
          
            # –ü—Ä–∏–º–µ—Ä: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–æ–π –≤–µ—Ç–∫–∏
            echo "üîÑ Updating related branches..."
            # git checkout develop
            # git merge main --no-ff -m "Merge main after PR #${{ github.event.pull_request.number }}"
            # git push origin develop
          
            echo "‚úÖ Specific actions for add-friends-likes completed"
          fi
          
          # –û–±—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ª—é–±–æ–π approved –≤–µ—Ç–∫–∏
          echo "üìä Generating reports..."
          # mvn site  # –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
          
          echo "üéâ All post-merge actions completed!"

      # 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –Ω–µ-approved –≤–µ—Ç–æ–∫
      - name: Skip non-approved branch
        if: steps.check-branch.outputs.approved == 'false'
        run: |
          echo "‚è≠Ô∏è Skipping: Branch ${{ github.event.pull_request.head.ref }} not in approved list"
          echo "No actions required."